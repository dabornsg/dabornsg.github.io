<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="A Fool’s Errand - Q-Learning: Building an environment (Dig-DuQ part 2)" /><meta property="og:locale" content="en" /><meta name="description" content="Hey, welcome back. Hopefully you’ve read the previous part of this wonderful mini-series, which was all about initial theorical stuff and pseudo-planning. So now, get ready for a more technical post, where we’ll be developing our DigDuQ environment! I’ll be writting this following my experience, so sorry if the pacing seems a little off." /><meta property="og:description" content="Hey, welcome back. Hopefully you’ve read the previous part of this wonderful mini-series, which was all about initial theorical stuff and pseudo-planning. So now, get ready for a more technical post, where we’ll be developing our DigDuQ environment! I’ll be writting this following my experience, so sorry if the pacing seems a little off." /><link rel="canonical" href="https://dabornsg.github.io/posts/a-fool-s-errand-q-learning-building-an-environment-dig-duq-part-2/" /><meta property="og:url" content="https://dabornsg.github.io/posts/a-fool-s-errand-q-learning-building-an-environment-dig-duq-part-2/" /><meta property="og:site_name" content="Daniel’s Fool’s Journey" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-18T18:49:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="A Fool’s Errand - Q-Learning: Building an environment (Dig-DuQ part 2)" /><meta name="twitter:site" content="@na" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-19T23:08:18-04:00","datePublished":"2022-04-18T18:49:00-04:00","description":"Hey, welcome back. Hopefully you’ve read the previous part of this wonderful mini-series, which was all about initial theorical stuff and pseudo-planning. So now, get ready for a more technical post, where we’ll be developing our DigDuQ environment! I’ll be writting this following my experience, so sorry if the pacing seems a little off.","headline":"A Fool’s Errand - Q-Learning: Building an environment (Dig-DuQ part 2)","mainEntityOfPage":{"@type":"WebPage","@id":"https://dabornsg.github.io/posts/a-fool-s-errand-q-learning-building-an-environment-dig-duq-part-2/"},"url":"https://dabornsg.github.io/posts/a-fool-s-errand-q-learning-building-an-environment-dig-duq-part-2/"}</script><title>A Fool's Errand - Q-Learning: Building an environment (Dig-DuQ part 2) | Daniel's Fool's Journey</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Daniel's Fool's Journey"><meta name="application-name" content="Daniel's Fool's Journey"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/vplp.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Daniel's Fool's Journey</a></div><div class="site-subtitle font-italic">A blog about programming rants and such</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/dabornsg" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/da-bornsg/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['dabornsg','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>A Fool's Errand - Q-Learning: Building an environment (Dig-DuQ part 2)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>A Fool's Errand - Q-Learning: Building an environment (Dig-DuQ part 2)</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/dabornsg">Daniel Bornscheuer</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1650322140" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-18 </em> </span> <span> Updated <em class="timeago" data-ts="1650424098" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-19 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2438 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><p>Hey, welcome back. Hopefully you’ve read the <a href="https://dabornsg.github.io/posts/a-fool-s-errand-q-learning-planning-ahead-dig-duq-part-1/">previous part</a> of this wonderful mini-series, which was all about initial theorical stuff and pseudo-planning. So now, get ready for a more technical post, where we’ll be developing our DigDuQ environment! I’ll be writting this following my experience, so sorry if the pacing seems a little off.</p><h2 id="setting-the-gym-up"><span class="mr-2">Setting the Gym up</span><a href="#setting-the-gym-up" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>At first, I was wondering how people develop environments for reinforcement learning, and searching for a lil’ bit I found out about <a href="https://gym.openai.com/">OpenAI’s Gym</a>, which they advertise as “<em>a toolkit for developing and comparing reinforcement learning algorithms. It supports teaching agents everything from walking to playing games like Pong or Pinball.</em>” Which is exactly what we need for what we’re doing!</p><p>Luckily, creating a new environment isn’t very hard. Following the <a href="https://www.gymlibrary.ml/">docs</a>, we set up our initial files and get started right away writing DigDuQ’s environment. First, we create a new class derived from <code class="language-plaintext highlighter-rouge">gym.Env</code>, and set it up the following (admittedly barebones) way:</p><div file="digdug_env.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="digdug_env.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">DigdugEnv</span><span class="p">(</span><span class="n">gym</span><span class="p">.</span><span class="n">Env</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">"human"</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></table></code></div></div><p>Now what does all of this mean? Excellent question, let have a little discussion on what’s the deal with these functions.</p><ul><li><code class="language-plaintext highlighter-rouge">__init__()</code>: Here we will declare whatever variables we need and also what Gym calls the action and observation space. We’ll talk more about those later on, but consider them as the definition of the number of actions you can do within the environment and how its state is represented, respectively.<li><code class="language-plaintext highlighter-rouge">reset()</code>: We need some way to start the environment in a clean state, for example in case we get a game over. This function will handle everything so that training can be done continuously even if the env stops for some reason or the other.<li><code class="language-plaintext highlighter-rouge">step(action)</code>: This one’s a bit more interesting than the last two. In this function, we need to define how to pass a given action to the environment, and from it extract an observation, the reward gained from the action, and whether the simulation is done or not.<li><code class="language-plaintext highlighter-rouge">render(mode)</code>: This is used if you need some way to render your simulation to the screen, in case you run it from inside the class. As you’ll see later, I’m not writting an emulator from scratch, so we’ll not be using this function.<li><code class="language-plaintext highlighter-rouge">close()</code>: When ending the simulation, if we need to clean anything up, we’ll call this function. As simple as it gets.</ul><p>Now that we have a clearer picture as to what we need to write in order to get a gym for our agent going, so it’s time to get to the nitty and gritty. First of all, how are we getting the game to actually run and have it pass information into our system?</p><h2 id="time-to-dig"><span class="mr-2">Time to Dig</span><a href="#time-to-dig" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Finally it’s time to actually start thinking. After some research, I decided to use the NES version of Dig Dig for our little gym. A decision partially motivated by laziness, but it’ll help us later on. For this, we’ll use the <a href="https://fceux.com">FCEUX</a> emulator, which actually supports Lua for scripting, a feature that will be useful for getting some information about the state of the game easily. Now that we know where to run the game, it’s time to think about how to pass actions, how to get observations, rewards, and the “done” state (AKA are we dead yet?).</p><h3 id="observations"><span class="mr-2">Observations</span><a href="#observations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3C/svg%3E" data-src="../../assets/img/DigdugSquare.png" alt="Example Dig Dug frame for our purposes" width="200" height="200" class="right" data-proofer-ignore> I’m going to base many assumptions on the investigation presented in <a href="https://www.deepmind.com/publications/playing-atari-with-deep-reinforcement-learning">DeepMind’s Deep Reinforcement Learning paper</a>, in which they trained agents to play Atari games. One of these hypotheses is that agents can learn just with video data, and as such, observations can very well just be the video component of the game. Also, I’m going to assume that the agent can understand what’s going on with just a grayscale picture. With this, we will define our observation space as a box of 190x190 pixels to encompass just the game square, which comes at just a little less total pixels than the 210x160 canvas of DeepMind, and using only one color instead of 3. Let’s do our instantation of the observation space then:</p><div file="digdug_env.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="digdug_env.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="p">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">190</span><span class="p">,</span> <span class="mi">190</span><span class="p">)),</span>
                                        <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">190</span><span class="p">,</span> <span class="mi">190</span><span class="p">)),</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float16</span><span class="p">)</span>
</pre></table></code></div></div><p>Finally some action! Here we define our space as a box of 190x190, where each value can be a floating point number (as in, decimal) between zero and one, nice! Now, getting the image will be a bit of a hassle. This is the part where I’m probably gonna start getting death threats sent to my email, but I’m actually doing this on Windows, because my Linux machine is nowhere near as powerful as what you need for a machine learning task. Now that that’s out of the way, the method I used to get the pixel info was Python’s <code class="language-plaintext highlighter-rouge">PIL</code> library’s <code class="language-plaintext highlighter-rouge">ImageGrab()</code> function, where we can pass a set of coordinates and it’ll get the pixels in that place. We get the coordinates from <code class="language-plaintext highlighter-rouge">win32gui</code>, and also the window handle, which will be useful for input later on. If you’re interested on the actual implementation, check out the project’s <a href="https://github.com/dabornsg/DigDuQ">GitHub repo</a>, it’s on the <code class="language-plaintext filepath highlighter-rouge">gym-digdug/gym_digdug/envs/digdug_env.py</code> file.</p><h3 id="actions"><span class="mr-2">Actions</span><a href="#actions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Alright, we have a way of seeing what’s happening on the screen, now time to interact with it! For Dig-Dug, the number of actions is actually somewhat small, we can move either up, down, left or right, or we can launch our trusty bike pump forward to destroy the enemies on the level. That’s a total of 5 possible actions, which means that our action space is a <em>discrete</em> vector of size 5, which we will promptly insert into our <code class="language-plaintext highlighter-rouge">__init__</code> function:</p><div file="digdug_env.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="digdug_env.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="p">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">190</span><span class="p">,</span> <span class="mi">190</span><span class="p">)),</span>
                                        <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">190</span><span class="p">,</span> <span class="mi">190</span><span class="p">)),</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float16</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="p">.</span><span class="n">Discrete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    
    <span class="bp">self</span><span class="p">.</span><span class="n">action_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">Key</span><span class="p">.</span><span class="n">up</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Key</span><span class="p">.</span><span class="n">down</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">Key</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="n">Key</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s">'f'</span><span class="p">}</span>
</pre></table></code></div></div><p>With this, we are just saying that we have 5 possible actions to choose from. You may also notice a cheeky little line at the bottom, that’s where I defined what our actions really are. Gym’s <code class="language-plaintext highlighter-rouge">action_space</code> actually just defines a list of numbers from 0 to whatever number we said, so the way I chose to map those numbers to actual inputs is with that dictionary. For passing those inputs to the emulator, I’m using <code class="language-plaintext highlighter-rouge">pynput</code> to control the keyboard from the Python script. The emulator bindings are arrows for the direction pad, <code class="language-plaintext highlighter-rouge">f</code> for the A button, <code class="language-plaintext highlighter-rouge">p</code> for loading a save state, and <code class="language-plaintext highlighter-rouge">k</code> to advance to the next frame as long as it’s being pressed. You’ll know what we need those latter two buttons after a bit.</p><h3 id="rewards"><span class="mr-2">Rewards</span><a href="#rewards" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>This is an interesting part. I’ve said the word “reward” a couple of times before, but I think I <em>haven’t</em> actually defined what rewards are, and that’s cause rewards will vary depending on the environment. In general, rewards are a quantifiable way of knowing how are well are we doing in our space, which doesn’t actually say a lot, so let’s try to establish what our rewards are for Dig-Dug. I say try because that’s actually not as simple as it sounds in my opinion.</p><p>At first glance, we could say that our reward is our score. I mean, traditionally with these games the higher the score the better we are doing right? And that’s still true for Dig-Dug, however, <strong>the game’s objective is not necessarily getting a high score, it’s to kill the monsters in the level (or letting them escape).</strong> You could argue that, considering that killing enemies gives a lot of points when compared to just digging, score could still be a nice reward quantifier, but DeepMind stated that their approach <em>couldn’t differentiate between rewards of different magnitude</em>, and for that reason they just set positive rewards as 1, negative rewards as -1, and no changes as 0. Of course, a paper from 2013 might be somewhat outdated, so we’re not gonna let that deter us. As such, I propose trying two ways of setting up our rewards, using our game score (without capping the rewards like DeepMind did), and using the <em>remaining number of enemies</em> as the other, which means that a positive reward is given when there are less enemies on the screen.</p><p>Enough theory crafting, how do we get that info in our environment? Here’s where being able to script in FCEUX comes in handy. After <em>digging</em> a bit with the RAM Search function, I found the addresses where the score, number of remaining enemies, and lives are stored in the NES’s memory, and created a pipe to communicate between Lua and Python to transmit information from the emulator into our cozy space. This is way easier said than done, especially considering I’ve never used pipes in Windows before, and last time I used them at all was like 3 years ago. Regardless, the implementation is available for you all to see the duct-taped solution I managed to come up with. I won’t really delve further into it here because this section is already getting long and I have no cutesy things to add to it, but if you read the repository and need some help understanding what I did feel free to reach out.</p><h2 id="step-by-step"><span class="mr-2">Step by Step</span><a href="#step-by-step" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Let’s discuss what we’re gonna do for our <code class="language-plaintext highlighter-rouge">step()</code> and <code class="language-plaintext highlighter-rouge">reset()</code> functions. First, for resetting, we need to restart the number of lives we have and score points as 3 and 0, respectively (that’s what the game starts with, after all). After that, we’ll be focusing the FCEUX Windows with the help of our handy <code class="language-plaintext highlighter-rouge">win32gui</code> library, and telling the emulator to load a previously created save state in the initial frame of the first level in Dig-Dug by sending a <code class="language-plaintext highlighter-rouge">p</code> keypress. After that, we grab an image of our stage, and make the function return it for our agent.</p><p>Now, for stepping in our environment, first we need to make sure our action is a valid one (after all, we have no way of knowing what a number 3.5 or 523 means as an action in our context). After that, we press <code class="language-plaintext highlighter-rouge">k</code> to start advancing frames, while at the same time sending the keypress mapped to the action we received. That means for example if we got a 2, we’ll be sending a left arrow key press to the emulator. While these two buttons are being pressed, we will wait for the Lua script to send us the information we said before, meaning our lives, remaining enemies and current score. This will happen after 30 in-game frames (a somewhat arbitrary number, I know), after which we release both keys and stop the emulation, and grab our screenshot of what’s the state of our game right now. Finally, we check if we’re still alive and set that as our <code class="language-plaintext highlighter-rouge">done</code> flag. What we return then is the grayscale picture of our current state, our reward (which is defined as either <em>the difference between our last step’s score and the current one</em> or <em>the difference of remaining enemies between the last and current step</em> depending on our settings), and whether we’re still alive or not with our <code class="language-plaintext highlighter-rouge">done</code> flag.</p><p>It’s time to start getting it all together. I’m not going to paste the whole code here because it’s full of stuff that’s not really needed to understand what’s happening, but let’s fill up our initial <code class="language-plaintext highlighter-rouge">DigdugEnv</code> class with pseudocode mixed with Python using what we have discussed here:</p><div file="digdug_env.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="digdug_env.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">DigdugEnv</span><span class="p">(</span><span class="n">gym</span><span class="p">.</span><span class="n">Env</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">observation_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="p">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">190</span><span class="p">,</span> <span class="mi">190</span><span class="p">)),</span>
                                        <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">190</span><span class="p">,</span> <span class="mi">190</span><span class="p">)),</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="n">action_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="p">.</span><span class="n">Discrete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">action_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">Key</span><span class="p">.</span><span class="n">up</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Key</span><span class="p">.</span><span class="n">down</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">Key</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="n">Key</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s">'f'</span><span class="p">}</span>
        <span class="n">lives</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">enemies</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">reward_type</span> <span class="o">=</span> <span class="s">'score'</span>
        <span class="n">pipe</span> <span class="o">=</span> <span class="n">win32pipe</span><span class="p">.</span><span class="n">CreateNamedPipe</span><span class="p">(...)</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lives</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">enemies</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">keyboard</span><span class="p">.</span><span class="n">press</span><span class="p">(</span><span class="s">'p'</span><span class="p">)</span> <span class="c1"># Load savestate
</span>        <span class="n">obs</span> <span class="o">=</span> <span class="n">ImageGrab</span><span class="p">.</span><span class="n">grab</span><span class="p">()</span> <span class="c1"># Take screenshot
</span>        <span class="k">return</span> <span class="n">obs</span>
        
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">action_space</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">action_map</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="c1"># Set action as our defined input
</span>        <span class="n">keyboard</span><span class="p">.</span><span class="n">press</span><span class="p">(</span><span class="s">'k'</span><span class="p">)</span> <span class="c1"># Advance frame
</span>        <span class="n">keyboard</span><span class="p">.</span><span class="n">press</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">.</span><span class="n">GetData</span><span class="p">()</span>
        <span class="n">keyboard</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="s">'k'</span><span class="p">)</span> <span class="c1"># Stop advancing frames
</span>        <span class="n">keyboard</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        
        <span class="n">obs</span> <span class="o">=</span> <span class="n">ImageGrab</span><span class="p">.</span><span class="n">grab</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">reward_type</span> <span class="o">==</span> <span class="s">'score'</span><span class="p">:</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">score</span> <span class="o">-</span> <span class="n">score</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="n">enemies</span> <span class="o">-</span> <span class="n">data</span><span class="p">.</span><span class="n">enemies</span>
        <span class="n">lives</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">lives</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">score</span>
        <span class="n">enemies</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">enemies</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">lives</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">"human"</span><span class="p">):</span>
        <span class="k">pass</span> <span class="c1"># Considering the emulator renders for us, we don't need to fill this up
</span>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">keyboard</span><span class="p">.</span><span class="n">press</span><span class="p">(</span><span class="s">'p'</span><span class="p">)</span> <span class="c1"># Return to save state
</span></pre></table></code></div></div><h2 id="testing-what-we-have-and-conclussion"><span class="mr-2">Testing what we have and conclussion</span><a href="#testing-what-we-have-and-conclussion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>After all that stuff, we can finally test our environment. For that, I made a small Jupyter Notebook where I can test stuff out. Currently it’s not much more than what the basic test for environments described in Gym’s docs is, but here we’ll later create our agent to play around and start training.</p><div file="digduQ.ipynb" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="digduQ.ipynb"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">gym_digdug</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="p">.</span><span class="n">make</span><span class="p">(</span><span class="s">'digdug-v0'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">episode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">env</span><span class="p">.</span><span class="n">render</span><span class="p">()</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">action_space</span><span class="p">.</span><span class="n">sample</span><span class="p">()</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Step reward: </span><span class="si">{</span><span class="n">reward</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
         <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Episode finished after </span><span class="si">{</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s"> steps"</span><span class="p">)</span>
         <span class="k">break</span>
<span class="n">env</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></table></code></div></div><p>Here, we use <code class="language-plaintext highlighter-rouge">gym.make()</code> to instance our created environment, use <code class="language-plaintext highlighter-rouge">reset()</code> to get the initial observation, and start playing around in the game. Currently, using <code class="language-plaintext highlighter-rouge">action = env.action_space.sample()</code> just gives us a random action, but it will do to check if we’re doing stuff right or not. So now we run the script and… <img data-src="../../assets/img/DigDugRandom.gif" alt="GIF of environment working" data-proofer-ignore> <em>Look at him go!</em></p><p>You can see when <code class="language-plaintext highlighter-rouge">k</code> is being pressed when there’s no pause sign at the bottom right. But other than that, we can see how the script is indeed interacting with the emulator, and I can assure you dear reader that it’s getting the score and remaining enemies and all that jazz.</p><p>Whew, kind of a long read, but hey, a good gym needs a good post to describe it. Not sure if I’d call this gym good though, but at least it gets the job done. Now that we have an environment, it’s time to get to the good part and start developing the agent. Tune in next time to see how that goes.</p><p>Before you leave, let me recommend you <a href="https://www.youtube.com/watch?v=gjDrEdEzfQc">this song</a>. Thanks for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/machine-learning/'>Machine Learning</a>, <a href='/categories/q-learning/'>Q-Learning</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ai/" class="post-tag no-text-decoration" >ai</a> <a href="/tags/ml/" class="post-tag no-text-decoration" >ml</a> <a href="/tags/q-learning/" class="post-tag no-text-decoration" >q-learning</a> <a href="/tags/digdug/" class="post-tag no-text-decoration" >digdug</a> <a href="/tags/nes/" class="post-tag no-text-decoration" >nes</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=A Fool&#39;s Errand - Q-Learning: Building an environment (Dig-DuQ part 2) - Daniel&#39;s Fool&#39;s Journey&amp;url=https://dabornsg.github.io/posts/a-fool-s-errand-q-learning-building-an-environment-dig-duq-part-2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=A Fool&#39;s Errand - Q-Learning: Building an environment (Dig-DuQ part 2) - Daniel&#39;s Fool&#39;s Journey&amp;u=https://dabornsg.github.io/posts/a-fool-s-errand-q-learning-building-an-environment-dig-duq-part-2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://dabornsg.github.io/posts/a-fool-s-errand-q-learning-building-an-environment-dig-duq-part-2/&amp;text=A Fool&#39;s Errand - Q-Learning: Building an environment (Dig-DuQ part 2) - Daniel&#39;s Fool&#39;s Journey" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/a-fool-s-errand-q-learning-building-an-environment-dig-duq-part-2/">A Fool's Errand - Q-Learning: Building an environment (Dig-DuQ part 2)</a><li><a href="/posts/a-fool-s-errand-q-learning-planning-ahead-dig-duq-part-1/">A Fool's Errand - Q-Learning: Planning ahead (Dig-DuQ part 1)</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ai/">ai</a> <a class="post-tag" href="/tags/digdug/">digdug</a> <a class="post-tag" href="/tags/ml/">ml</a> <a class="post-tag" href="/tags/nes/">nes</a> <a class="post-tag" href="/tags/q-learning/">q-learning</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/a-fool-s-errand-q-learning-planning-ahead-dig-duq-part-1/"><div class="card-body"> <em class="timeago small" data-ts="1650266100" > 2022-04-18 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>A Fool's Errand - Q-Learning: Planning ahead (Dig-DuQ part 1)</h3><div class="text-muted small"><p> One of the things that has always piqued my interest ever since I was but a wee lad has been artificial intelligence. Teaching inanimate objects in a way that resembles how humans learn is a fascin...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/a-fool-s-errand-q-learning-planning-ahead-dig-duq-part-1/" class="btn btn-outline-primary" prompt="Older"><p>A Fool's Errand - Q-Learning: Planning ahead (Dig-DuQ part 1)</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/dabornsg">Daniel Bornscheuer</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ai/">ai</a> <a class="post-tag" href="/tags/digdug/">digdug</a> <a class="post-tag" href="/tags/ml/">ml</a> <a class="post-tag" href="/tags/nes/">nes</a> <a class="post-tag" href="/tags/q-learning/">q-learning</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
